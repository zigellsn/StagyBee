{% extends 'base.html' %}
{% load i18n static %}

{% get_current_language as LANGUAGE_CODE %}

{% block title %}Stage{% endblock %}

{% block header %}
    {% include "stage/header.html" %}
{% endblock %}

{% block content %}
    <script type="text/hyperscript">
        def showMessage(msg)
            call Swal.fire({title: '{% trans "Nachricht" %}', html: msg, confirmButtonColor: '#3b82f6'})
            if result.isConfirmed or result.isDismissed then
                fetch {% url 'console:action' credential.congregation %} {method:"POST", headers: { X-CSRFToken:"{{ csrf_token }}", Content-Type: "application/x-www-form-urlencoded"}, body:"action=message-ack"}
            end
        end

        eventsource Alerts from http:/ws/{{ LANGUAGE_CODE }}/message/{{ credential.congregation|escape }}/
            on message_alert as string
                showMessage(it)
            end
        end
    </script>

    <div hx-ws="connect:/ws/{{ LANGUAGE_CODE }}/console/{{ credential.congregation|escape }}/">
        <div id="overlay"></div>
    </div>
    <div hx-ws="connect:/ws/{{ LANGUAGE_CODE }}/extractor/{{ credential.congregation|escape }}/">
        <div id="sum-listeners"></div>
        <div id="listeners"></div>
        <div id="activity"></div>
        <form hx-post="{% url "stage:extractor_connect" pk=credential.congregation %}"
              hx-swap="outerHTML" hx-trigger="htmx:load from:closest div">
            <input name="action" value="connect" hidden>
        </form>
    </div>
{% endblock %}

{% block footer %}
    <footer>
        {% if not credential.touch and credential.send_times_to_stage %}
            <div hx-ws="connect:/ws/{{ LANGUAGE_CODE }}/console/{{ credential.congregation|escape }}/">
                <div class="w-full" hx-swap="outerHTML">
                    <div class="progress-container bg-gray-100 dark:bg-gray-800 shadow-lg dark:shadow-gray-800">
                        <div class="progress-bar bg-blue-500" id="pb">
                            <div class="w-screen text-black dark:text-white text-xl text-center" style="margin-top: -3px;font-family: monospace;">00:00:00&nbsp;|&nbsp;00:00:00</div>
                        </div>
                    </div>
                    <div class="hidden">
                        <div id="talk-name-caption"></div>
                        <div id="id_talk_index"></div>
                        <div id="elapsed"></div>
                        <div id="remaining"></div>
                        <div id="scrim"></div>
                        <div id="message"></div>
                        <div id="listener-count"></div>
                        <div id="request-to-speak-count"></div>
                        <div id="waiting-indicator"></div>
                    </div>
                </div>
            </div>
        {% endif %}
    </footer>
{% endblock %}

{% block body_extra %}
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}