{% partialdef message %}
    {% load i18n %}
    <form hx-post="{% url 'console:action' credential.congregation %}" hx-swap="none">
        <label for="text_message" class="pt-4">{% trans "Textnachricht" %}</label><br>
        <textarea name="message" class="w-full dark:bg-black mb-2 w-full border rounded-sm resize-y mt-2"
                  id="text_message"
                  _="on pointermove
                    send calc_size to the next <[role=region]/> from the first <[aria-expanded=true]/>
                end"></textarea>
        <div class="pt-4">
            <button name="action" value="message-send"
                    class="bg-blue-500 hover:bg-blue-700 inline-flex justify-center items-center text-white font-bold py-2 px-4 rounded-sm mb-2 cursor-default">
                <span class="uppercase">{% trans "Sende Nachricht" %}</span>
            </button>
        </div>
        <div id="waiting-indicator"></div>
        <div id="message" hx-swap-oob="afterend"></div>
    </form>
{% endpartialdef %}

{% partialdef scrim-control %}
    {% load i18n %}
    <form hx-post="{% url 'console:action' credential.congregation %}" hx-swap="none">
        <div class="flex flex-row">
            {% partial scrim-control-button %}
            <button name="action" value="scrim-refresh"
                    class="bg-blue-500 hover:bg-blue-700 inline-flex justify-center items-center text-white font-bold py-2 px-4 rounded-sm mb-2 cursor-default ltr:ml-2 rtl:mr-2">
                <span>{% include 'icons/refresh.html' %}</span></button>
        </div>
    </form>
{% endpartialdef %}

{% partialdef scrim-control-button %}
    {% load i18n %}
    <button name="action" value="scrim-toggle" id="scrim"
            class="bg-blue-500 hover:bg-blue-700 inline-flex justify-center items-center text-white font-bold py-2 px-4 rounded-sm mb-2 cursor-default">
        <span class="uppercase">{% if dark == False %}{% trans "Bildschirm verdunkeln" %}{% else %}
            {% trans "Verdunkelung aufheben" %}{% endif %}</span></button>
{% endpartialdef %}

{% partialdef status %}
    {% load i18n qr_code %}
    <table class="table-auto w-full">
        <tbody>
        <tr>
            <td class="w-2/3 border-r-2 ltr:pr-4 rtl:pl-4">
                <div hx-ext="ws"
                     ws-connect="/ws/{{ LANGUAGE_CODE }}/extractor/{{ credential.congregation|escape }}/listener/"
                     class="flex justify-center">
                    {% trans "Meldungen:" as sum_request_to_speak %}
                    {% trans "Zuhörer gesamt:" as sum_listeners %}
                    <table class="table-auto w-1/2 text-lg">
                        <thead>
                        <tr>
                            <th class="px-5 py-3 border-b-2 text-center text-lg font-semibold uppercase tracking-wider"
                                colspan="2">{% trans "Status" %}</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td class="px-5 text-lg">{{ sum_listeners }}</td>
                            <td class="px-5 text-lg">
                                <div id="listener-count"></div>
                            </td>
                        </tr>
                        <tr>
                            <td class="px-5 text-lg">{{ sum_request_to_speak }}</td>
                            <td class="px-5 text-lg">
                                <div id="request-to-speak-count"></div>
                            </td>
                        </tr>
                        <tr>
                            <td class="px-5 text-lg">{% trans "Seit" %}</td>
                            <td class="px-5 text-lg">{{ credential.since|time:"TIME_FORMAT" }}</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </td>
            <td class="w-1/3">
                <div class="flex justify-center">
                <span class="hidden dark:inline">
                {% qr_from_text timer_url options=qr_options_dark size=12 version=6 %}
                </span>
                </div>
                <div class="flex justify-center">
                <span class="dark:hidden">
                {% qr_from_text timer_url options=qr_options_light size=12 version=6 %}
                </span>
                </div>
                <div class="text-center">{% trans "Link zur Stoppuhrsession" %}</div>
            </td>
        </tr>
        </tbody>
    </table>
{% endpartialdef %}

{% partialdef talks %}
    {% load i18n %}
    {% get_current_language as LANGUAGE_CODE %}
    <ul class="p-4"
        _="on htmx:afterSwap
        add .p-4 to the first <ul.workbook/>
        js return StagyBee.DateTime.now().toFormat('yyyyMMdd'); end set date to it
        for line in <li.line/> index i
            add .border-gray-400 .hover:bg-blue-300 to line
            if line@data-part is 0
                put '<strong>&nbsp;&bull;&nbsp;</strong>' at the start of line
            end
            if date <= '20231231'
                if line@data-part is 1
                    put '<strong style=&quot;color: #626262;\&quot;>&nbsp;&bull;&nbsp;</strong>' at the start of line
                end
                if line@data-part is 2
                    put '<strong style=&quot;color: #9d5d07;\&quot;>&nbsp;&bull;&nbsp;</strong>' at the start of line
                end
                if line@data-part is 3
                    put '<strong style=&quot;color: #942926;\&quot;>&nbsp;&bull;&nbsp;</strong>' at the start of line
                end
            else
                if line@data-part is 1
                    put '<strong style=&quot;color: #3c7f8b;\&quot;>&nbsp;&bull;&nbsp;</strong>' at the start of line
                end
                if line@data-part is 2
                    put '<strong style=&quot;color: #d68f00;\&quot;>&nbsp;&bull;&nbsp;</strong>' at the start of line
                end
                if line@data-part is 3
                    put '<strong style=&quot;color: #bf2f13;\&quot;>&nbsp;&bull;&nbsp;</strong>' at the start of line
                end
            end
            set @data-index of line to i + 1
            if ( #id_talk_index@value is 0 and i is 0 ) or ( #id_talk_index@value is not 0 and #id_talk_index@value is i + 1 )
                if #id_talk_index@value is not 0
                    remove .opacity-50 .cursor-not-allowed from #timer-stop
                    add .hover:bg-blue-700 to #timer-stop
                    add .running to line
                end
                send click to line
            end
            if line@data-directions is not null
                add .has-tooltip to line
                make a <div.tooltip.mt-2.rounded.dark:shadow-gray-800.shadow-lg.p-2.dark:bg-gray-700.bg-gray-100.dark:text-white.text-black.font-light/> called tooltip
                put line@data-directions into tooltip
                put tooltip at the end of line
            end
        end
    end

    on click if event.target matches .line then
        take .bg-blue-500 from .line for event.target
        set hours to ( ( event.target@data-content / 60 ) as an Int )
        if hours > 4 then set hours to 4 end
        put ( ( event.target@data-content - ( hours * 60 ) ) as an Int ) into #id_m.value
        put hours into #id_h.value
        put 0 into #id_s.value
        set @value of #id_talk_name to event.target@data-caption
        set @value of #id_talk_index to event.target@data-index
        set @value of #id_talk_user to event.target@data-custom
        if event.target@data-custom is 'true' then
            show #custom-talk
            transition #custom-talk opacity to 1
        else
            transition #custom-talk opacity to 0
            hide #custom-talk
        end
        send calc_size to the next <[role=region]/> from the first <[aria-expanded=true]/>
    end">
        <li><span class="italic">{% trans 'Leben-und-Dienst-Zusammenkunft' %}</span>
            <div hx-get="{% url 'workbook_today' language=LANGUAGE_CODE %}{% querystring filter='times' %}"
                 hx-trigger="load" hx-swap="outerHTML" hx-target="this">
                <ul class="p-4">
                    <li style="text-align: center;display: inline-block;">
                        <div class="pt-4 self-center stroke-current text-violet-600 mb-8"
                             style="transform: scale(2.0);">{% include 'icons/activity_indicator.html' %}</div>
                    </li>
                </ul>
            </div>
        </li>

        {% with total=times|length %}
            <li><span class="italic">{% trans 'Zusammenkunft für die Öffentlichkeit' %}</span>
                <ul class="p-4">
                    <li class="line border-gray-400 hover:bg-blue-300"
                        data-caption="{% trans 'Öffentlicher Vortrag (30 Min.)' %}" data-index="{{ total|add:"1" }}"
                        data-content="30">{% trans 'Öffentlicher Vortrag (30 Min.)' %}</li>
                    <li class="line border-gray-400 hover:bg-blue-300"
                        data-caption="{% trans 'Wachtturm-Studium (60 Min.)' %}" data-index="{{ total|add:"2" }}"
                        data-content="60">{% trans 'Wachtturm-Studium (60 Min.)' %}</li>
                </ul>
            </li>

            <li><span class="italic">{% trans 'Benutzerdefiniert' %}</span>
                <ul class="p-4">
                    <li class="line border-gray-400 hover:bg-blue-300"
                        data-caption="{% trans 'Benutzerdefiniert' %}" data-index="{{ total|add:"3" }}"
                        data-content="10"
                        data-custom="true">{% trans 'Benutzerdefiniert' %}</li>
                </ul>
            </li>
        {% endwith %}
    </ul>
{% endpartialdef %}

{% partialdef timer %}
    {% load i18n %}

    <div class="hidden">
        <div id="pb"></div>
        <div id="listeners"></div>
        <div id="activity" class="animate-pulse ltr:mr-2 rtl:ml-2"></div>
        <div id="overlay"></div>
        <div id="sum-listeners"></div>
    </div>
    <div class="pt-8 pb-8">
        <div id="talk-name-caption" class="flex justify-center"></div>
    </div>
    <div>
        <table class="table-auto flex justify-center">
            <tbody>
            <tr>
                <th class="px-9">
                    <div class="text-center uppercase">{% trans "Abgelaufen" %}</div>
                </th>
                <th class="px-9">
                    <div class="text-center uppercase">{% trans "Übrig" %}</div>
                </th>
            </tr>
            <tr>
                <td class="px-9">
                    <div style="font-size:32px; font-family: monospace;">
                        <div id="elapsed">
                            <span>00:00:00</span>
                        </div>
                    </div>
                </td>
                <td class="px-9">
                    <div style="font-size:32px; font-family: monospace;">
                        <div id="remaining">
                            <span>00:00:00</span>
                        </div>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <label for="talk-list" class="pt-4 font-semibold">{% trans "Programm" %}</label>
    {% partial talks %}
    <form hx-post="{% url "console:stopwatch:stopwatch" pk=credential.congregation %}"
          hx-swap="none">
        <div id="custom-talk" class="px-4 pb-6" style="display: none;">
            <div class="pt-2 dark:bg-gray-800 bg-white flex">
                {% csrf_token %}
                {{ form }}
            </div>
        </div>
        <div class="flex flex-row pt-4">
            <button name="action" value="timer-start"
                    class="bg-blue-500 hover:bg-blue-700 inline-flex justify-center items-center text-white font-bold py-2 px-4 rounded-sm mb-2 cursor-default"
                    _="on click add .running to <li.bg-blue-500/>
                                        add .hover:bg-blue-700 .cursor-default to #timer-stop
                                        remove .opacity-50 .cursor-not-allowed from #timer-stop">
                {% include 'icons/start.html' %}<span class="ltr:ml-2 rtl:mr-2 uppercase">{% trans "Start" %}</span>
            </button>
            <button name="action" id="timer-stop" value="timer-stop"
                    class="bg-blue-500 hover:bg-blue-700 opacity-50 cursor-not-allowed inline-flex justify-center items-center text-white font-bold py-2 px-4 rounded-sm mb-2 cursor-default ltr:ml-2 rtl:mr-2"
                    _="on click
                       for line in <li.bg-blue-500/>
                        if line matches .running and line.nextElementSibling is not null then
                            send click to next <li.line/> from line
                        end
                    end
                    remove .running from <li.line/>
                    add .opacity-50 .cursor-not-allowed to me
                    remove .hover:bg-blue-700 .cursor-default from me">
                {% include 'icons/stop.html' %}<span class="ltr:ml-2 rtl:mr-2 uppercase">{% trans "Stopp" %}</span>
            </button>
        </div>
    </form>
{% endpartialdef %}

{% partialdef workbook %}
    {% load i18n %}
    {% for workbook in workbooks %}
        <ul class="workbook" lang="{{ language }}" data-date="{{ workbook.date }}">
            {% for talk in workbook.times %}
                <li class="line" data-caption="{{ talk.talk }}" data-part="{{ talk.kind }}"
                    {% if talk.time %}data-content="{{ talk.time }}"{% endif %}
                    {% if talk.directions %}data-directions="{{ talk.directions }}"{% endif %}>{{ talk.talk }}</li>
            {% empty %}
                <li>{% trans 'Es konnten keine passenden Programmpunkte im Arbeitsheft gefunden werden.' %}</li>
            {% endfor %}
        </ul>
    {% empty %}
        <div>{% trans 'Das Arbeitsheft konnte nicht geladen werden.' %}</div>
    {% endfor %}
{% endpartialdef %}
