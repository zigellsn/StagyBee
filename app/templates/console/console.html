{% extends 'console/choose_console_base.html' %}
{% load i18n sb_qr_code %}

{% block content %}
    {% get_current_language as LANGUAGE_CODE %}
    {% get_current_language_bidi as LANGUAGE_BIDI %}
    <div>
        <span class="text-2xl">{{ credential.display_name }}</span>
    </div>
    <div hx-ws="connect:/ws/{{ LANGUAGE_CODE }}/console/{{ credential.congregation|escape }}/" class="flex flex-col"
         _="on click
                take .selected from .acc-header for the closest <div.acc-header/> to the event.target
                take .rotate-180 from .icon for (<svg/> in closest <div.acc-header/> to the event.target)">
        <div class="my-2 dark:bg-gray-800 shadow-lg acc-header selected">
            <div class="flex flex-row justify-between items-center font-semibold p-3 cursor-pointer">
                <span>{% trans "Stoppuhr" %}</span>
                {% include 'icons/chevron_down.html' with rotate=True %}
            </div>
            <div class="dark:bg-gray-800 acc-content px-4 overflow-hidden max-h-0 ease duration-500">
                <div style="display: none;">
                    <div id="progress-bar"></div>
                </div>
                <div id="talk-name-caption" class="text-leader pt-8 pb-8">
                    <span>{% trans "Aufgabe" %}&nbsp;</span><i><span></span></i>
                </div>
                <div>
                    <table class="table-auto">
                        <tbody>
                        <tr>
                            <th class="px-9">
                                <div>{% trans "Abgelaufen" %}</div>
                            </th>
                            <th class="px-9">
                                <div>{% trans "Übrig" %}</div>
                            </th>
                        </tr>
                        <tr>
                            <td class="px-9">
                                <div id="elapsed" style="font-size:32px">
                                    <span style="font-family: monospace;">00:00:00</span>
                                </div>
                            </td>
                            <td class="px-9">
                                <div id="remaining" style="font-size:32px">
                                    <span style="font-family: monospace;">00:00:00</span>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <label for="talk-list" class="pt-4">{% trans "Aufgabe" %}</label>
                {% include 'console/fragments/talks.html' %}
                <form hx-post="{% url "console:stopwatch:stopwatch" pk=credential.congregation %}"
                      hx-swap="none">
                    <div id="custom-talk" class="px-4" style="display: none;">
                        <div class="pt-2 dark:bg-gray-800 bg-white flex">
                            {% csrf_token %}
                            {{ form }}
                        </div>
                    </div>
                    <div class="pt-4">
                        <button name="action" value="timer-start"
                                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded inline-flex items-center"
                                _="on click add .running to <li.bg-blue-500/>
                                        add .hover:bg-blue-700 to #timer-stop
                                        remove .opacity-50 .cursor-not-allowed from #timer-stop">
                            {% include 'icons/start.html' %}<span>{% trans "Start" %}</span>
                        </button>
                        <button name="action" id="timer-stop" value="timer-stop"
                                class="bg-blue-500 opacity-50 cursor-not-allowed text-white font-bold py-2 px-4 rounded inline-flex items-center"
                                _="on click
                                           for line in <li.bg-blue-500/>
                                            if line matches .running and line.nextElementSibling is not null then
                                                send click to next <li.line/> from line
                                            end
                                        end
                                        remove .running from <li.line/>
                                        add .opacity-50 .cursor-not-allowed to me
                                        remove .hover:bg-blue-700 from me">
                            {% include 'icons/stop.html' %}<span>{% trans "Stopp" %}</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="my-2 dark:bg-gray-800 shadow-lg acc-header">
            <div class="flex flex-row justify-between items-center font-semibold p-3 cursor-pointer">
                <span>{% trans "Bildschirmsteuerung" %}</span>
                {% include 'icons/chevron_down.html' %}
            </div>
            <div class="dark:bg-gray-800 acc-content px-4 overflow-hidden max-h-0 ease duration-500">
                <table class="table-auto" style="width:20%">
                    <tr>
                        <td>
                            {% include 'console/events/scrim_control.html' %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="my-2 dark:bg-gray-800 shadow-lg acc-header">
            <div class="flex flex-row justify-between items-center font-semibold p-3 cursor-pointer">
                <span>{% trans "Textnachricht" %}</span>
                {% include 'icons/chevron_down.html' %}
            </div>
            <div class="dark:bg-gray-800 acc-content px-4 overflow-hidden max-h-0 ease duration-500">
                <form hx-post="{% url 'console:action' credential.congregation %}" hx-swap="none">
                    <label for="text_message" class="pt-4">{% trans "Textnachricht" %}</label><br>
                    <textarea name="message" class="w-full text-black border rounded resize-y mt-2"
                              id="text_message"></textarea>
                    <div class="pt-4">
                        <button name="action" value="message-send" hx-trigger="click"
                                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">{% trans "Sende Nachricht" %}</button>
                    </div>
                    <div id="message" hx-swap-oob="afterend"></div>
                </form>
            </div>
        </div>

        <div class="my-2 dark:bg-gray-800 shadow-lg acc-header">
            <div class="flex flex-row justify-between items-center font-semibold p-3 cursor-pointer">
                <span>{% trans "Livedaten" %}</span>
                {% include 'icons/chevron_down.html' %}
            </div>
            <div class="dark:bg-gray-800 acc-content px-4 overflow-hidden max-h-0 ease duration-500">
                <table class="w-full table-fixed">
                    <tbody>
                    <tr>
                        <td class="w-2/3 border-r-2">
                            <div hx-ws="connect:/ws/{{ LANGUAGE_CODE }}/extractor/{{ credential.congregation|escape }}/" class="flex justify-center">
                                {% trans "Meldungen:" as sum_request_to_speak %}
                                {% trans "Zuhörer gesamt:" as sum_listeners %}
                                <table class="w-1/4 text-lg">
                                    <caption class="border-b-2"><span
                                            class="text-leader">{% trans "Status" %}</span></caption>
                                    <tbody>
                                    <tr>
                                        <td>{{ sum_listeners }}</td>
                                        <td>
                                            <div id="listener-count"></div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>{{ sum_request_to_speak }}</td>
                                        <td>
                                            <div id="request-to-speak-count"></div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>{% trans "Seit" %}</td>
                                        <td>{{ credential.since|time:"TIME_FORMAT" }}</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </td>
                        <td class="w-1/3">
                            <div class="flex stroke-current text-black dark:text-white justify-center">
                                {% qr_from_text timer_url size=12 version=6 %}
                            </div>
                            <div class="text-center">{% trans "Link zur Stoppuhrsession" %}</div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="talk"></div>
    <script type="text/hyperscript">
        socket Timer ws:/127.0.0.1:8000/ws/{{ LANGUAGE_CODE }}/timer/{{ credential.congregation|escape }}/
        end
    </script>

{% endblock %}
